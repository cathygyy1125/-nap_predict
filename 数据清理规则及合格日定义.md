文档所述规则仅适用于 构建模型训练数据集，用于保证训练样本的质量与一致性。在 用户侧睡眠分析 中，系统展示的结果始终基于用户的原始记录，不受这些清理规则影响。

---
前置说明
一共有三类睡眠事件： 清晨起床、小睡（开始/结束）、夜间就寝 。前端交互对于这三种事件有强制的约束设计：
1. 有就寝才能有晨起
- 不允许创建“晨起”，除非已存在上一晚“就寝”。
- 若无：弹出阻断式引导 → “请先补充昨晚的就寝时间”。
2. 有晨起才能有小睡
- 不允许创建小睡开始，除非已存在当日“晨起”锚点。
- 若无：弹出阻断式引导 → “请先补充今天的晨起时间”。
3. 晨起/就寝事件无法删除
- 一旦创建了晨起/就寝时间，只能修改时间，无法删除事件本身。
- 修改时间时需保持日内逻辑顺序：
  - bedtime(D-1) < wake(D) < first_nap_start(D) < bedtime(D)。
  - 若 new_wake_time >= first_nap_start → 阻断保存。
  - 同理，修改就寝时间也需保证晚于当日最后一次小睡的结束时间，否则阻断保存。
4. 所有的睡眠事件区间互不重叠
- 若重叠：弹出阻断式引导。
5. 不允许创建大于 6 个小时的小睡记录
  - 阻断保存。
  - 若使用计时器，引导修改小睡记录。

1. 数据模型与约束
- 事件有三类：bedtime, wake, nap(start/end)；并有事件日（按当地时区派生）。
- 不可变式
  - wake(D) 必须存在且在 bedtime(D-1) 之后。
  - 任意 nap_i(D) 的 start_time 必须在 wake(D) 之后、bedtime(D) 之前。
  - nap_i.start < nap_i.end，且 nap_i 区间互不重叠。
- 存储层校验
  - 若缺 wake(D)：拒绝写入 nap.start；返回可恢复错误码（供前端弹窗）。
  - 若缺 bedtime(D-1)：拒绝写入 wake(D)。
- 首次使用例外（边界 1）：允许 wake(D0) 无前一晚 bedtime，但将 D0 标为 onboarding_day=true。
- 跨午夜处理：夜间就寝 bedtime(D-1)→wake(D) 允许跨日；
2. 清洗规则
单条过滤
出现以下事件则删除该条记录
- 持续时长 < 10 分钟的睡眠事件，判定为误触或中途暂停计时。
日程级过滤（合格日判定）
出现以下事件定义为不合格
1. 小睡次数过滤
- 以“原始群体均值”为基准，若当日小睡次数超出均值±2.5 次的区间，则判定为不合格。
  - 原始群体均值来源：参考前端 `nap_summary_table.tsx`（表内 `mean` 列）；在 `eb_nap_probability.tsx` 中优先使用该参考值。
  - 若某月龄缺少表内均值，则回退为 CSV 估计均值：mean_csv = Σ k·p_k。
  - 取整规则（用于最终保留范围）：min = ceil(mean − 2.5)，max = floor(mean + 2.5)，并截断到 [0,6]。
  - 示例：若 mean=3.51，则区间为 [1.01, 6.01]，最终保留范围 [2, 6]（含端点）。
2. 小睡时长过滤
- 当日若有任何 nap 时长 >210 分钟（3.5 小时）。

注：对于晨起 < 04:00 或 >14:00，或者就寝 <17:00的异常情况，先不删除该日数据，但是可以打标签，后续看是否会影响醒窗的预测。

3. 预想的边界与兜底
1. 新用户首日
- 允许录“晨起”而不强制昨晚“就寝”；当日数据标记为 onboarding_day。
- 第二天起恢复强制链。
2. 清洗数据时需要考虑有未关闭的 nap session 如何处理？
  - 把该 nap 标记为 quarantined，并在数据集中加上 quarantine_reason = 'end_at_null'。
  - 在原始仓库保留，不进入模型训练/评估。
  - 用户再次进入app提示编辑小睡，补录结束时间。




---
数值依据
 https://www.utupub.fi/bitstream/handle/10024/178690/Fernandez-Rajal_Anna_Thesis.pdf?sequence=1
https://mybabyzzz.com/blog/article/114
