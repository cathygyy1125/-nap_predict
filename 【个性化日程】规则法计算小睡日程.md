本文档描述了在样本量有限、无法直接训练机器学习模型的阶段，如何通过轻量化的规则方法在个体层面生成每日小睡与就寝日程。
该方法是对“两过程模型（Process S/C）”的工程化近似，以群体基线为起点，结合近期个体观测数据，先离线拟合、再在线校正生成小睡日程。

---
1. 任务
任务流程概述：
每天凌晨，系统执行以下流程：
1. 获取当日目标宝宝的 年龄（月龄）、近期合格日记录；
2. 调用模型 1（计数模型）获得今日小睡次数 $$\hat{N}$$；【个性化日程】经验贝叶斯法计算小睡次数
3. 在月龄基线的基础上，融合个体历史数据；
4. 通过规则法计算各小睡的开始时间与持续时间；
5. 输出初始日程v0

---
2. 参数定义
$$S$$：先验强度，默认 7
$$n$$：近 7 天内合格日且小睡次数等于今日预测小睡次数 $$\hat{N}$$，并且排除异常晨起时间天数；
估计量： 清醒时长 $$\hat{WW_k}$$和小睡时长 $$\hat{D_k}$$，时间一律换成分钟计算；
$$r$$：晨起偏移对后续 nap 的 传导系数，r = [0.70, 0.45, 0.30, 0.20, 0.15]（分别对应 nap1…nap5）

---
3. 建模思路与计算过程
分成两阶段：
1. 前一晚离线计划生成初始日程v0 
2. 次日晨起后，根据实际晨起时间，在线校正生成第一次校正版本v1

---
3.1 阶段 1 ：离线计划生成初始日程v0 
3.1.1 预测小睡次数
获得预测小睡次数 $$\hat{N}$$ 
【个性化日程】经验贝叶斯法计算小睡次数

---
3.1.2 排除异常晨起日
- 取滚动时间窗内 $$W $$内， 发生$$\hat{N}$$次小睡的合格日，N 不一致的天不参与后续 晨起时间  $$\hat{wake} $$ ，清醒时长$$WW_k$$ 和持续时长 $$D_k$$ 估计，避免混型污染
- 进一步排除异常晨起日。异常晨起日判断规则详见 3.2 异常晨起日判断规则

---
3.1.3 预估晨起时间
1. 将 3.1.2 排除异常晨起日后的每个合格日的晨起时间转为分钟（相对当天 00:00）
2. 经验贝叶斯加权（与“次数 EB”同权重口径）：
  群体均值数据见：
  3-35 月龄小睡次数&日程模板
$$\hat{wake} =
\underbrace{\frac{S}{S + n}}_{\text{群体权重}} \mu_{\text{wake}}^{(\text{age})}
+ 
\underbrace{\frac{n}{S + n}}_{\text{个体权重}} \text{wake}^{\text{ind}}
$$
- 特例：n=0 → 直接取 $$\hat{wake} =\mu_{\text{wake}}^{(\text{age})}$$

举例
 先验强度 S = 7，有效样本 n =2 ：
- 群体先验均值：$$\mu_{\text{wake}}^{(\text{age})}$$= 07:00（420 分钟）
- 有效样本：6:30（390）、7:00（420） → n =2
- 个体特征： $$wake^{ind}$$  = median(390, 420) = 405（= 6:45）
权重：
- 群体权重 = ( $$ \frac{S}{S+n} = \frac{7}{9} \approx 0.7778$$ )
- 个体权重 = ( $$\frac{n}{S+n} = \frac{2}{9} \approx 0.2222$$ )
计算：
$$\hat{wake} = \frac{7}{9}\cdot 420 + \frac{2}{9}\cdot 405
 = \frac{2940 + 810}{9}
 = \frac{3750}{9}
 = 416.67\text{ min}≈ 06:57
$$

- 有效样本：6:30（390）、7:00（420） → n =2
- 个体特征： $$wake^{ind}$$  = median(390, 420) = 405（= 6:45）

---
3.1.4 计算清醒时长 $$\hat{WW_k}$$和小睡时长 $$\hat{D_k}$$
1. 数据来源：近 7 天合格日中小睡次数 = $$\hat{N}$$的日子。
  1. 只在预估晨起时间的时候才剔除异常晨起日，前提假设是：异常晨起时间不会大幅度影响后续的 WW 和 D，因此在计算 WW 和 D时，仍然保留异常晨起日数据，以防数据量太少。
2. 计算nap_k次小睡发生前的清醒时长 $$WW_k$$ 、以及小睡持续时长 $$D_k$$
3. 通过经验贝叶斯融合分别计算 $$\hat{WW_k}$$、$$\hat{D_k}$$ ，得到宝宝的个性化日程模板值
对任意连续指标 X（$$WW_k$$ 或 $$D_k$$）：
$$\widehat{X}_k = 
\underbrace{\frac{S}{S + n}}_{\text{群体权重}} \mu_{X_k}^{(\text{age})}
+ 
\underbrace{\frac{n}{S + n}}_{\text{个体权重}} \overline{X}_k^{(\text{ind})}
$$

$$μ_{X_k}^{(age)}$$：年龄段群体均值，参考儿科指南基线表
$$\bar{X}_k^{(ind)}$$：近 7 天合格日（且小睡次数 = $$\hat{N}$$）下，个体数据的均值

举例
- 场景：6 月龄、2 次小睡 $$(\hat N=2)$$ 
- 先验强度：(S=7)；有效天数：(n=2)。
- 年龄段群体均值（参考基线表）：
 $$(\mu_{WW_1}^{(age)}=150) 分，(\mu_{WW_2}^{(age)}=210) 分；$$
- $$(\mu_{D_1}^{(age)}=90) 分，(\mu_{D_2}^{(age)}=90) 分$$。

两个合格日原始记录：
Day 1：7:00 起；9:30–10:45（Nap1）；14:30–15:55（Nap2）；19:00 就寝
Day 2：6:30 起；9:00–10:45（Nap1）；14:00–15:35（Nap2）；18:30 就寝

---
1. 计算当日的  $$WW_k$$  与  $$D_k$$ 
Day 1：
$$WW_1 =150 分；D_1=75 分；$$
$$WW_2 = 225 分；D_2 = 85 分$$。
Day 2：
$$WW_1 =150 分；D_1=105 分；$$
$$WW_1 =195 分；D_1=95 分；$$

---
2. 计算个体清醒时长和小睡时长的特征值
取中位数（或温莎化均值）作为个体统计   $$\overline{X}_k^{(ind)}$$ （抗极端值）
- $$\overline{WW_1}^{(ind)} = \text{median}(150,150) = \mathbf{150}$$
- $$\overline{WW_2}^{(ind)} = \text{median}(225,195) = \mathbf{210}$$
- $$\overline{D_1}^{(ind)} = \text{median}(75,105) = \mathbf{90}$$
- $$\overline{D_2}^{(ind)} = \text{median}(85,95) = \mathbf{90}$$

思考：未来可以对出现短觉的合格日降低权重

---
3. 经验贝叶斯融合，得到模板 $$\hat{WW_k}$$， $$\hat{D_k}$$
对任意连续量  $$X \in {WW_k, D_k}：$$
 
$$ \widehat{X}_k = \frac{S}{S+n}\mu{X_k}^{(age)} + \frac{n}{S+n}\overline{X}_k^{(ind)}
 \quad\text{（这里 }S=7, n=2\text{）}$$
 
权重：群体 (= $$\tfrac{7}{9}\approx0.7778$$ )，个体 (= $$\tfrac{2}{9}\approx0.2222$$ )。

逐项计算（结果四舍五入到整数分钟）：
- $$\hat{WW_1} = \tfrac{7}{9}\cdot150 + \tfrac{2}{9}\cdot150 = \mathbf{150}$$ 分
- $$\hat{WW_2} = \tfrac{7}{9}\cdot210 + \tfrac{2}{9}\cdot210 = \mathbf{210}$$ 分
- $$\hat{D_1} = \tfrac{7}{9}\cdot90 + \tfrac{2}{9}\cdot90 = \mathbf{90}$$ 分
- $$\hat{D_2} = \tfrac{7}{9}\cdot90 + \tfrac{2}{9}\cdot90 = \mathbf{90}$$ 分

---
4. 输出（进入 v0 的个性化模板值）

$$ \boxed{\hat{WW_1}=150,\ \hat{WW_2}=210,\ \hat{D_1}=90,\ \hat{D_2}=90}$$
 
 后续按 3.1.5 用 $$\hat{wake} $$ 叠加这些模板生成 离线初始日程 v0；
 晨起后再按 3.1.6 做“递减传导”微调即可。

---
3.1.5 离线生成初始日程v0 
得到预估晨起时间 $$\hat{wake} $$和个性化日程模板值  $$\hat{WW_k}$$和 $$\hat{D_k}$$，生成第二天的初始日程v0 ，以两次小睡的日程为例：
Nap 1 :   
nap_1_start= $$\hat{wake} $$ + $$\hat{WW_1} $$；
nap1_dur = $$\hat{D_1}$$；
nap_1_end = nap_1_start+ nap_1_dur
Nap 2 ：
nap_2_start= nap_1_end + $$\hat{WW_2} $$；
nap_2_dur = $$\hat{D_2}$$；
nap_2_end = nap_2_start+ nap_2_dur

---
3.2 阶段 2 ：根据实际晨起时间生成微调版本v1
当日真实晨起产生后，对离线初始日程 v0（由 §3.1.3–3.1.5 生成）进行平滑对齐。
要求：对 nap1 最敏感，越往后影响越小；就寝尽量守锚点。支持 N∈{0,1,2,3,4,5}。
晨起偏移对 nap1 最大，对后续nap的影响递减传导

---
- 设 Δwake = wake_actual - $$ \hat{wake} $$ （分钟；正=晚起，负=早起）
- 对第 k 次小睡（k=1..N）做线性传导：
固定系数表（默认推荐）
r = [0.70, 0.45, 0.30, 0.20, 0.15]（分别对应 nap1…nap5）
nap_k_start' = nap_k_start + r[k] * Δwake

3.3 异常晨起日判定说明
根据研究，晨起时间相对稳定。经验上，婴儿睡眠节律的自然波动一般在 ±60 分钟内。
然而，婴儿会因夜醒、外部干扰或家庭作息变化，偶尔出现明显“晚起”或“早起”的情况。这些都属于“外部扰动”，而非稳定节奏。
如果将这些极端值直接纳入模板更新，会导致个体节奏参数（清醒窗、就寝锚点）被一次性拉偏，模型在次日“反向过度修正”。
因此需要设定“异常晨起日”规则，在保持当天可预测性的同时，避免污染长期模板。

---
判断逻辑
1. 计算典型晨起时间
- 取最近 $$W $$天内发生$$\hat{N}$$次小睡日晨起时间；
- 取其中位数作为宝宝的典型晨起时刻；

2. 与典型晨起时间计算差值
- 计算每一天的晨起时间与典型晨起时间的差值
- 若某天偏差 ≥ 90 分钟，则判定为“异常晨起日”。

举例：
1. 取最近 $$7$$天内发生$$3$$次小睡日晨起时间：7:00、6:30、9:00。
2. 排序取中位数：6:30 < 7:00 < 9:00，→ 把 7:00 视为这个宝宝的“近期典型晨起时间”
3. 计算每一天和典型晨起的差值：
暂时无法在飞书文档外展示此内容
→ Day3 标记为异常晨起日，当天数据不参与计算生成初始日程v0

3.4 短觉降权规则
目的：更新个体模板时（ $$WW_k$$ 、$$D_k$$），弱化“短觉带来的临时扰动”，保持长期节奏稳定。 
定义短觉：短觉判断标准和具体阈值 

---
降权对象（只给“补救性加觉”的天降权）
- 对当天实际次数 $$ N_d$$：
  - 若 $$N_d$$ >= $$\hat{N}$$+ 1 ，且当日短觉占比 $$\rho_d \geq 1/3$$ ，降权该天参数；
    - 例如，3 月龄冷启动时 $$\hat{N}= 4 (纯群体先验）$$，若当天实际小睡次数 $$ N_d \geq 5$$，例如 5 次，且当日出现 2 次以上的短觉，降权该天参数。
  - 其他情况 → 不降权。
  
权重设定
- 小睡时长 $$D_k$$：若第 k 次小睡为短觉，则该日样本对 $$D_k$$ 的权重 $$w^{(D)}_{k,d} = w_{short}$$ ，否则为 1.0。
- 下一段清醒时长 $$WW_{k+1}$$：若第 k 次小睡为短觉，则该日样本对 $$WW_{k+1}$$ 的权重 $$w^{(WW)}_{k+1,d} $$= $$w_{short}$$（体现“短觉影响下一段清醒窗”）。 $$WW_1$$ 不受影响。
- 其余段落维持权重 1.0。默认 $$w_{short} = 0.5$$。
稳健聚合与有效样本量
- 对任意连续量 $$X ∈ {WW_k, D_k}$$：
  - 个体统计 $$\overline{X}_k^{(ind)}=\operatorname{weighted\_median}\big(\{X_{k,d}\},\{w^{(X)}_{k,d}\}\big)$$
- 有效样本量 $$n_{\text{eff}}^{(X_k)}=\sum_d w^{(X)}_{k,d}$$（只对该 $$X_k$$ 聚合所用的样本求和）。
EB 融合（把原公式中的 n 替换为 $$n_{eff}$$）
- 记群体均值 $$\mu_{X_k}^{(age)}$$，先验强度 S。
- 计算：
  - $$ \widehat{X}_k = \underbrace{\frac{S}{S+n_{\text{eff}}^{(X_k)}}}_{\text{群体权重}}\,\mu_{X_k}^{(age)}
 \, + \,
 \underbrace{\frac{n_{\text{eff}}^{(X_k)}}{S+n_{\text{eff}}^{(X_k)}}}_{\text{个体权重}}\,\overline{X}_k^{(ind)}$$


最小落地步骤（实现指引）
- 对每个 k 和每一天 d：
  - 判定是否短觉；得到该日该段的权重 w（短觉用 $$w_{short}$$，否则 1.0）。
  - 对 $$D_k$$：用对应的权重累积样本；对 $$WW_{k+1}$$：如前一段短觉则降权。
- 对每个 $$WW_k$$ 或 $$D_k$$：
  - 计算加权中位数或温莎化加权均值。
  - 计算 $$ n^{(X_k)}_{eff}$$ = 权重之和。
  - 用 EB 融合公式得到 $$\hat{WW_k},\hat{D_k}$$。
