本文档描述了离线层经验贝叶斯方法生成小睡次数 N（模型 1）的计算过程、参数定义。
目标：解决在真实样本很少或没有时，先用群体先验稳定输出；随着该宝宝的“合格日”积累，逐步向个体收敛。

---
1. 任务
在样本量有限（新用户、冷启动）的情况下，用群体规律指导个体预测，并随着个体记录逐步“放大个体权重”。在两个层次的信号之间做平衡。

每天凌晨根据给定月龄与近期个体观测，计算小睡次数 $$N$$ 的分布并输出最终的第二天小睡预测次数 $$\hat{N}$$， $$\hat{N}$$将作为模型 2（计算小睡开始时间&持续时长）的输入参数。
2. 参数定义
滚动窗口 $$W $$：7 天；
先验强度 $$S $$ : 7，当观测到的合格日数量达到最大时（7 天），个体权重达到最大，占 50%；
合格日：数据清理规则
3. 建模思路
使用模型：Dirichlet-Multinomial（狄利克雷-多项式）模型
它由两层组成：
1. 狄利克雷分布（Dirichlet）：给出每个类别（比如 1觉 / 2觉 / 3觉）的“潜在概率”，即群体先验；
2. 多项式分布（Multinomial）：在这些潜在概率下，观测到若干次结果（比如最近7天每天的实际小睡次数），即个体似然。
暂时无法在飞书文档外展示此内容
4. 群体先验分布
小睡次数群体分布
小睡次数 N（0–5 次），分布来源参考 https://parentdata.org/sleep-survey-results-naps/

- 先验强度：设 $$S=7$$，控制先验“自信度”，S 越大，群体先验对预测结果影响越大，反之，个体似然对预测结果影响越大。
- 先验参数：$$ \boldsymbol{\alpha}^{(prior)} = S \cdot \mathbf{p}^{(age)} \quad$$
5. 似然
- 取滚动窗口 $$W$$ 内的合格日（数据清理规则），得到各小睡次数的计数向量 $$\mathbf{c}=(c_0,c_1,c_2,c_3,c_4,c_5)，(n=\sum c_k)$$
6. 融合公式
 $$\boldsymbol{\alpha}^{(post)}=\boldsymbol{\alpha}^{(prior)}+\mathbf{c}$$
- 后验均值（次数 k 发生的概率）：

$$ 
 \hat\theta_k =;\frac{\alpha_k^{(\text{post})}}{\sum_{j=0}^5 \alpha_j^{(\text{post})}}
 =
 \frac{,S\cdot p_k^{(age)} + c_k,}{,\underbrace{\sum_{j}(S\cdot p_j^{(age)})}_{=S} + \underbrace{\sum_{j}c_j}_{=n},}
 =
 \frac{S\cdot p_k^{(age)} + c_k}{S+n}.
 $$
分子： $$S\cdot p_k^{(age)} + c_k$$ ；分母： $$S+n$$ 

把上面公式改写成加权平均的形式：
$$
\hat{\theta}_k = 
\underbrace{\frac{S}{S + n}}_{\text{群体权重}} \cdot p_k^{(\text{age})}
\;+\;
\underbrace{\frac{n}{S + n}}_{\text{个体权重}} \cdot \frac{c_k}{n}
$$

后验分布 = 群体分布 × 群体权重 + 个体分布 × 个体权重
有效样本 n 越大（即个体数据越多），群体权重就越小，个体权重就越大
群体权重 = 1- 个体权重

7. 输出结果
- 点预测：预测次数$$\hat{N}= \arg\max_k \hat{\theta}_k$$ ，概率
- 同时记录「第二可能的预测次数 N」及其概率 $$P_{top2}$$ ，如给出 N=3（ $$P_{top1}=$$ 56%），N=4（ $$P_{top2}$$ =28%）
  - 计算置信度 $$Confidence =P_{top1} - P_{top2}


$$
  - 若置信度 < 阈值（0.2），则说明宝宝正处在阶段过渡期（如 4→3 小睡转型期）
  
8. 一个具体算例
- 7 月龄，S = 7 
- 归一化后的群体先验概率：
$$\mathbf{p}^{(age)} \approx [\,0,\;0.60,\;0.40,\;0,\;0,\;0\,]$$
- 个体近 7 天（滚动窗口）共有 3 个合格日，观测到：一次 2 naps、两次 3 naps 
  → $$\mathbf{c}=[0,0,1,2,0,0]$$ $$⇒ n=3$$（合格日的天数）

- 权重：S=7，n=3 $$\Rightarrow \frac{S}{S+n}=0.7, \frac{n}{S+n}=0.3$$
- 个体相对频率： $$\frac{\mathbf c}{n}=[0,0,\tfrac{1}{3},\tfrac{2}{3},0,0]$$

$$ \hat{\boldsymbol\theta}
 =0.7[0,0,0.60,0.40,0,0]+0.3[0,0,\tfrac{1}{3},\tfrac{2}{3},0,0]
 =[0,0,0.52,0.48,0,0]$$
 
 输出结果：2 次小睡（0.52）

---

9. 短觉降权（可选，低置信时启用）

目的：当近端记录被短觉干扰、且模型对小睡次数判断不够自信时，降低这些“扰动日”的影响，避免误判阶段转型。

启用条件（建议门控）
- 先按标准流程计算一次后验与置信度：
  - $$\hat N=\arg\max_k\,\hat\theta_k$$，置信度 $$\text{Confidence}=P_{top1}-P_{top2}$$。
- 若 $$\text{Confidence}<\tau_{conf}$$（默认 0.2）→ 启用短觉降权；否则保持标准结果。

权重定义（逐日）
- 对滚动窗内每个“合格日” d，计算当天短觉占比（不含计划性短睡/衔接觉）：
  $$\rho_d=\frac{\#\{\text{短觉段}\}}{\max(N_d,1)}\in[0,1]$$。
- 将天级权重设为：
  $$w_d = \max\big(w_{\min},\;1-\beta\cdot\rho_d\big)\in[w_{\min},1]$$，默认 \(\beta=0.5,\ w_{\min}=0.5\)。

加权计数与有效样本量
- 对于次数 k 的计数：
  $$c'_k = \sum_{d\in W,\;N_d=k} w_d,\qquad n_{\text{eff}}=\sum_{k=0}^5 c'_k=\sum_{d\in W} w_d.$$

加权后验（以 \(n_{\text{eff}}\) 替代 \(n\)）
$$
 \hat\theta'_k = \frac{S\cdot p_k^{(age)} + c'_k}{S + n_{\text{eff}}}
 = \underbrace{\frac{S}{S+n_{\text{eff}}}}_{\text{群体权重}}\,p_k^{(age)}
 + \underbrace{\frac{n_{\text{eff}}}{S+n_{\text{eff}}}}_{\text{个体权重}}\,\frac{c'_k}{n_{\text{eff}}}.
$$

输出与记录
- 若触发降权：输出 $$\hat N'=\arg\max_k\,\hat\theta'_k$$ 及其置信度；同时保留未降权版本用于监控（便于评估影响）。
- 未触发降权：沿用未加权版本结果。

边界与说明
- 计划性短睡（衔接觉）不计入短觉；极短(<10 分钟)已在清洗层剔除。
- 本方法等价于用“伪计数”近似加权个体似然；先验强度 S 不变，仅将分母中的 n 替换为 $$n_{\text{eff}}$$。
- 为避免对真实阶段转型过度抑制，建议将本规则置于特性开关下（默认关闭，低置信时启用）。

---

10. 先验区间与就近模板映射（业务落地）

目的：当经验贝叶斯给出的点预测次数 $$\hat N$$ 明显偏离该月龄“合理先验范围”（群体常态）时，面向用户的日程不直接采用极端值，而映射为更健康/稳健的“就近模板”次数，并加入防抖与锁定，兼顾数据稳定与业务体验。

关键概念与参数（可配置）
- 先验范围：每个月龄对应的小睡次数合理区间（例如 4 月龄：3–5 次）。由群体分布与产品策略共同确定。
- 一致性窗口：近 W 天（与建模窗口一致，默认 7 天）的“合格日”观测用于判断是否“持续超界”。
- 超界判定：近 W 天内的合格日，观测次数均落在先验区间的同一侧（全部低于下界或全部高于上界），且样本天数达到阈值（如 ≥5 天）。
- 锁定期：触发一次模板映射后，至少 T 天内保持该映射结果（建议 T=7），避免频繁来回。
- 映射策略：优先映射到“最近的先验边界次数”（就近原则）。如需更保守策略，可按年龄白名单将上越界直接下压到边界下一个次数（例如 4 月龄 6 次 → 用 4 次模板），但须配套昼睡总量兜底。

流程（在线层/业务层在 EB 结果之上执行）
1) 计算 EB 后验与点预测：得到 $$\hat N$$、各次数后验概率、Top2 与置信度。
2) 先验内：若 $$\hat N$$ 落在该月龄先验范围内 → 直接采用 $$\hat N$$ 对应的模板。
3) 先验外但无一致性：若先验外，但近 W 天未达到“持续同侧超界” → 暂不映射，保留 $$\hat N$$，并记录“观察中”。
4) 先验外且一致性达标：
   - 采用就近边界映射：
     - 若 $$\hat N < L$$（下界 L）：用 L 次模板（例如 2 次 → 映射到 3 次模板）。
     - 若 $$\hat N > U$$（上界 U）：用 U 次模板（例如 6 次 → 映射到 5 次模板）。
   - 若命中“保守映射”年龄与规则：可将 U 侧上越界再下压 1 档（如 6 次 → 用 4 次模板）。
   - 进入锁定期 T 天；锁定期内仅当观测反向一致性强烈并且置信度高于阈值，方可解除。

输出口径（供下游日程/前端使用）
- `N_hat`: EB 点预测次数。
- `confidence`: Top1-Top2 的概率差。
- `within_prior`: 布尔，是否落在先验范围内；`prior_range=[L,U]`。
- `mapped_template_N`: 实际采用的模板次数（若未映射则等于 `N_hat`）。
- `mapping_reason`: none / below_prior / above_prior / conservative_override。
- `lock_until`: 若进入锁定，给出结束日期；未锁定则为空。

4 月龄示例（示意）
- 先验范围：[3,5]。
- 近 7 天全部 6 次，且达到样本天数阈值：
  - 就近原则 → `mapped_template_N=5`；
  - 若启用保守映射白名单 → `mapped_template_N=4`；需保证昼睡总时长与末次小睡兜底，避免过度疲劳。
- 近 7 天全部 2 次、样本达标 → `mapped_template_N=3`（下越界映射到下界）。
- 近 7 天全部 5 次 → 先验内，直接用 5 次模板。

与现有文档的衔接
- 本节位于 EB 推断之后，作为“业务层决策钩子”。不改动 EB 参数（S、W、清洗规则），仅在产出侧增加先验边界感知与稳定性控制。
- 推荐将“先验范围、样本阈值、一致性判定、锁定期、保守映射名单”做成可配置项，便于灰度与 A/B。
