1. # 目标与范围
    

- 当出现短小睡（< 45 分钟）时，仅**缩短下一段清醒时长**，让下一次入睡更靠前，提升当日作息稳定度。
    
- 当预测小睡**挤压到就寝前末段清醒窗口**时，**调整小睡次数和末次小睡时长**。
    
- 当末次小睡结束时间**已经挤压到就寝前末段清醒窗口**或**超过预计就寝时间**时，**调整就寝时间**。
    

  

2. # 关键定义
    

- **短小睡**：单段小睡的**实际睡眠时长** **< 45 分钟**。
    
- **预计就寝时间：**当天晨起生成的初始预测日程中的就寝时间。
    
- **基线清醒时长**：来自离线层参数或年龄基线的**下一段清醒时长（冷启动）**。
    
- **调整后清醒时长：**在短小睡场景下，按比例缩短后的下一段清醒时长。
    
- **就寝前小睡的最晚叫醒时间**（简称“最晚叫醒”）：
    
    - 计算方式：`最晚叫醒` = `预计就寝时间` − `基线末段清醒时长`。
        
- **白天睡眠不足：**以月龄段白天目标时长下限为准，目标日间睡眠时长下限 **-** 当前累计日间睡眠时长 > 45分钟 **。**
    

  

3. # 短小睡补偿规则集
    

当一次小睡比预期短时，说明睡眠压力释放不足；**仅缩短下一段清醒窗口**，帮助更早入睡。

**阈值与比例**
    
- 缩短比例：按月龄的短端比例执行（示例：**3–4 月龄缩短 20%**）。
    
- **情况 / 动作**
    
    - **情况**：出现短小睡。
        
    - **动作**：仅缩短**下一段清醒时长**（按对应月龄比例）；不改当日其余段落与就寝锚点。
        
    - **例如**：3–4 月龄，下一段基线清醒 120 分钟 → 缩短 20% → **96 分钟**。
        

> 注：本规则只改**下一段**，不连锁改后续所有段落。

---

4. # 就寝时间锚点保护
    

当日程因短觉或小睡延迟/过长而靠近就寝锚点时，按以下规则保护就寝时间与末段清醒窗口。

**有两种情况会出现需要保护就寝时间：**

1. **日程前移，加小觉：**当短觉过多，日程安排前移，可能会出现过长的末段醒窗，此时需要增加小觉，小觉的次数和末次小觉的时长需要根据规则计算。
    
2. **日程后移，减小觉：**当小觉延迟或者小觉过长，可能会出现日程安排后延，此时需要考虑靠近就寝时间的小觉是否需要缩短或跳过。
    

  

#### **规则 1：跳过晚间过近的小睡**

**条件（差值定义）**：

- 定义`差值` = `最晚叫醒` − `第 k 次小睡的`**`预计开始时间`**。
    
- 当 `差值` **< 30 分钟**（即该小睡距离就寝过近）。
    

**动作**：

- 直接**跳过第 k 次小睡及其后续全部小睡**（k+1、k+2…），当天不再新增小睡。
    
- **缺觉门控（新增）**：若白天睡眠不足 → **就寝前移** `min(差值, 30 分钟)`；否则就寝不动。
    
- **原因**：避免人为增加一清醒窗口导致就寝被推迟；若确实白天不足，则以小幅**提前就寝**通过夜间睡眠补足睡眠总量。
    

**例如**：

- 最晚叫醒 `17:45`；第 5 次小睡预计开始 `17:25` → 差值 `20 分钟` < `30 分钟`→ **不加**后续任何小睡。
    
    - 若白天睡眠不足→ 就寝 **前移 20 分钟**；否则不动。
        

**📌 等号边界**：**等于 30 分钟**不触发本规则，进入规则 2。

  

#### 规则 2：允许或截断小睡

当`差值` ≥ 30 分钟时，进入分支判断：

- **规则 2a：截断**
    
    - **情况**：**30 分钟 ≤****`差值`** **< 该次小睡的预测时长**。
        
    - **动作**：保留该次小睡，但将时长 **截断为差值**（确保在“最晚叫醒”前醒来）；**到达最晚叫醒后不再安排后续小睡**。
        
- **规则 2b：保留原时长**
    
    - **情况：**如果`差值`**≥ 该次小睡的预测时长**。
        
    - **动作**：保留原本预测的小睡开始时间和时长，不做调整
        

  

**📌 当前判断标准（V1）**：

- 以“预计就寝时间”和“基线末段清醒时长”推导“最晚叫醒”；
    
- 若需要**加一个小睡**，则“加小睡前的清醒窗口”和“小睡时长”**直接**复用**初始预测中的**`倒数第二段清醒窗口`**与**`倒数第二次小睡时长`。
    

  

  

以4个月为例：

按照基线表：预计就寝时间`19:45`，末段清醒时长`120分钟`，则往前推算，就寝前小睡的**最晚叫醒时间**为`17:45`

![](https://wcnjsnci3clo.feishu.cn/space/api/box/stream/download/asynccode/?code=MzA1OWE4ZjBmOTE4NzFhYTI1ZTU1Zjk0ZjQyYTc2MWRfZGxLeTBrNU1maEZqTmdBblVhbkRMR1NVRlFmOHZWU2lfVG9rZW46QUdzMmIzSnBOb2ZHVE94YXJXcWNLTGlnbjBnXzE3NTkxMjUzNzQ6MTc1OTEyODk3NF9WNA)

若判断是否能加第 5 次小睡（第 4 次小睡已确认保留）：

- 第 5 次小睡前的清醒窗口：**120 分钟**（示例不考虑短觉缩短）。
    
- 第 5 次小睡预计时长：**60 分钟**。
    
- 第 5 次小睡预计开始 = 第 4 次小睡结束 + 120
    
- 第 5 次小睡预计结束 = 预计开始 + 60
    

  

#### 根据规则有以下三种场景判断：

1. **不加小睡：**
    

- 若 **最晚叫醒 17:45 − 预计开始 < 30 分钟** → 不加后续任何小睡。
    
- 若白天睡眠不足，就寝 **前移 min(（最晚叫醒 17:45 − 预计开始)，30) 分钟**；
    

  

2. **加小睡且截断**：
    

- 若 **30 分钟 ≤（17:45 − 预计开始）< 60 分钟（预测时长）** → 加小睡，**截断时长**为该差值。
    

  

3. **加小睡且不截断**：
    

- 若 **预计结束 < 17:45** → 加小睡，**不截断**。
    

---

5. # 若末次小睡结束时间超过“就寝前小睡的最晚叫醒时间”
    

说明：这条规则**不引入短觉保护**

**末次小睡结束时间**：当天**最后一个已完成**的小睡的结束时间。

**顺延封顶：**就寝仅允许向后顺延最多 30 分钟**（以 30 分钟为分界）**

**等号边界说明：**等于“最晚叫醒”视为未超过，不触发本规则；等于“预计就寝”视为“未超过预计就寝”的分支。

**📌 触发后约束**：一旦触发本规则，当天**不再安排后续小睡**（若原计划仍有未开始的小睡，直接取消）。

---

1. ## 分支一：已超过【最晚叫醒】，但**未超过【预计就寝】**
    

**情况**：末次小睡结束时间比“最晚叫醒”更晚，但仍不晚于“预计就寝”。

**动作：将“预计就寝”按超出的时长等比顺延，但最多只顺延 30 分钟。**

- 顺延量 = `min(末次小睡结束时间 - 最晚叫醒, 30分钟)`
    
- 新的就寝建议 = `预计就寝` + `顺延量`
    

**例如**：

- 最晚叫醒 = `17:30`，预计就寝 = `19:00`，末次小睡结束 = `17:40` → 超出 10 分钟 → 就寝建议 = **`19:10`**。
    
- 最晚叫醒 = `17:30`，预计就寝 = `19:00`，末次小睡结束 = `18:30` → 超出 60 分钟，但封顶只顺延 30 分钟 → 就寝建议 = **`19:30`**。
    

  

2. ## 分支二：**已超过【预计就寝】**
    

- **情况：**末次小睡结束时间比“预计就寝”更晚。
    
- **动作**：
    
    - 在末次小睡结束时间基础上，**固定再加 30 分钟**，作为**新的就寝建议**。
        
    - 就寝建议 = `末次小睡结束时间`+ `30分钟`
        

**例如**：

- 预计就寝 = `19:00`，末次小睡结束 =`19:10`→ 就寝建议 = **`19:40`**。
    
- 预计就寝 = `19:00`，末次小睡结束 = `19:35`→ 就寝建议 = **`20:05`**
    

  

6. # 日内在线流程（V1）
    

## 初始化

1. **晨起记录** → 生成**基线日程**（各次小睡的预计开始/时长）与**初始就寝时间 v0**。
    
2. 计算**就寝前小睡的最晚叫醒时间**： 最晚叫醒 = v0 − 基线的末段清醒时长。
    

---

## 事件：第 1 次实际小睡（nap1）结束

A. 先看**是否超过“初始就寝 v0”**

- **超过** → **就寝时间 = nap1 实际结束时间 + 30 分钟**（记为 就寝时间v1）；
    
- **并且**：**取消当天所有后续未开始的小睡**；流程结束。
    

> - 说明：超过 v0 的同时也可视为超过“最晚叫醒”，因此直接进入“禁加后续小睡”的状态。
>     

B. 若**未超过 初始就寝v0**，再看**是否超过“最晚叫醒”**

- **超过**：
    
    - 计算超出时长。
        
    - **超出 ≤ 30 分钟** → **就寝 = v0 + 超出时长**
        
    - **超出 > 30 分钟** → **就寝 = v0 + 30 分钟**（封顶）
        
    - **并且**：**取消当天所有后续未开始的小睡**；流程结束。
        
- **未超过**：进入“是否安排 nap2”的评估。
    

---

## 评估是否安排 nap2（以“最晚叫醒”为唯一锚点）

1. 计算 **差值 = 最晚叫醒 − nap2 的预计开始时间**
    

> 若 nap1 是短小睡并执行了“短觉补偿”，nap2 的预计开始时间应使用**补偿后的**下一段清醒时长来计算。

2. 决策
    

- **差值 < 30 分钟** → **不安排 nap2**，同时不安排后续任何小睡；流程结束。
    
- **差值≥ 30 分钟**：
    
    - **30 分钟 ≤ 差值 < nap2 的预测时长** → **安排 nap2，但将时长截断为 差值**（确保在“最晚叫醒”前醒来）； 由于 nap2 结束时间将恰好到达“最晚叫醒”，**不再安排 nap3**；流程结束。
        
    - **差值 ≥ nap2 的预测时长** → **保留 nap2 原预计开始与时长，不做调整**；随后**用同样的逻辑继续评估 nap3**（重复“计算 gap → 三选一”的流程），直到检测到**无法安排**为止（即 **差值** < 30 或被截断至“最晚叫醒”）。
        

## 流程图

暂时无法在飞书文档外展示此内容

  

7. # 规则优先级
    

**从高到低**：

1. **超过预计就寝 v0** → 直接套“就寝顺延/重设”规则，并**取消所有未开始小睡**。
    
2. **超过“最晚叫醒”** → 按“≤30 顺延/＞30 封顶 +30”执行，并**取消未开始小睡**。
    
3. **就寝锚点保护（跳过/截断/保留）**。
    
4. **短/长小睡补偿**。
    

  

## 场景设定（4 月龄示例）

- **初始就寝 v0**：19:30
    
- **基线末段清醒**：120 分钟
    
- **就寝前最晚叫醒**：17:30（= 19:30 − 120）
    
- **Nap3 实际结束**：15:10
    
- **Nap3 是短觉**：30 分钟（<45 分钟）
    
- **Nap4 基线计划**：清醒 120 分钟后开始，时长 60 分钟 → 17:10–18:10（仅计划值）
    

---

## 正确流程（有**优先级**，避免打架）

📌优先级：①超过 v0 → ②超过最晚叫醒 → ③就寝锚点保护（跳过/截断）→ ④短觉补偿

1. **短觉补偿先只用于“计算下一段候选开始”** Nap3 短觉，按 4 月龄缩短 **下一段清醒 20%**：
    
    1. 新清醒 = 120 × (1 − 0.2) = **96 分钟**
        
    2. **Nap4 候选开始** = 15:10 + 96 = **16:46**
        
    3. 预测时长仍 60 分钟 → 候选结束 17:46（先不落锤）
        
2. **就寝锚点保护判断**（比补偿优先级高）
    
    1. 差值 = 最晚叫醒 17:30 − 候选开始 16:46 = **44 分钟**
        
    2. 满足 **30 分钟 ≤ 差值 < 预测时长 60 分钟** → **允许 Nap4，但“截断”到 44 分钟**
        
    3. **Nap4 最终落锤**：16:46–**17:30（截断到最晚叫醒）**
        
    4. 触发“到达最晚叫醒即不再安排后续小睡”的规则 → **不会再有 Nap5**
        
3. **短觉补偿不再“二次干预”末段清醒**
    
    1. 虽然 Nap4 被截断成 44 分钟（<45），但**优先级约束**：
        
        - 就寝锚点保护已经决定“到 17:30 结束，且不再安排后续小睡”
            
        - **短觉补偿无权再去缩短“最后一段清醒”（17:30→19:30）或挪动就寝 v0**
            
    2. **就寝仍为 v0 = 19:30**；末段清醒保持 120 分钟，节奏稳定
        

  

📌结果：既照顾了短觉后的更早入睡（把 Nap4 提前并截断），又**不让补偿去动就寝锚点**，避免“临近就寝又硬塞一觉”或“把 v0 提前/后移”。

---

## 错误做法（**无优先级**导致打架，会发生什么？）

- 流程若是：先短觉补偿 → **直接落锤 Nap4（16:46–17:46）** → 发现接近就寝再想补救……
    
- 可能出现两种错误：
    
    - **补偿覆盖了锚点保护**：系统让 Nap4 继续睡到 17:46，末段清醒只剩 104 分钟（17:46→19:30），甚至再对“末段清醒”继续做补偿，**把就寝从 19:30 错误地往前挪到 ~19:06**（96 分钟），破坏“v0 不滚动”的 V1 设定。
        
    - **锚点保护与补偿反复拉扯**：先想“截断/跳过”，又被“短觉补偿”改回要加小睡，行为抖动、体验混乱。
        

📌有了“**锚点保护优先于短觉补偿**”的规则，以上两种打架都不会发生。

---

## 再给一个更极端例子

- **Nap_k 结束 = 19:40（已超过 v0=19:30）**
    
- 正确：直接 **新就寝 = 19:40 + 30 = 20:10**，并取消未开始的小睡；**无论是否短觉，一律不再做补偿**。
    
- 说明：**“超过 v0”优先级最高**，一票否决补偿/加觉的冲动。
    

---

这两个例子展示了：

- 补偿**只影响下一段的候选开始**；
    
- **最终是否安排/截断/跳过**，由“就寝锚点保护”裁决；
    
- 一旦触发“超过 v0 / 超过最晚叫醒”的分支，**补偿不再有发言权**。 因此，系统的决策**单向、可复现、无抖动**。
    

  

  